<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <title>No Excuses: Verifying RSpec Test Doubles — Kevin Jalbert</title> <link href="/stylesheets/app.css" rel=stylesheet /> <link rel=alternate type="application/atom+xml" title="Posts — Kevin Jalbert" href="/feed.xml"/> </head> <div class=container> <div class=header> <div class="col-xs-4 col-md-4 banner"> <a href="/">Kevin Jalbert</a> </div> <div class="col-xs-8 col-md-8 navigation"> <ul> <li><input placeholder=Search class="search ui-autocomplete-input ui-corner-all" autocomplete=on></li> <li><a href="/about/">About</a></li> <li><a href="/now/">Now</a></li> </ul> </div> </div> </div> <body> <div class="container content article"> <div class=row> <div class=col-md-12> <h1 class=article__title><p>No Excuses: Verifying RSpec Test Doubles</p> </h1> <div class="row article__meta-info"> <div class="col-xs-4 col-md-4"> <div class=article__date>April 28, 2015 </div> </div> <div class="col-xs-4 col-md-4"> <div class=article__read-time>5 min read</div> </div> <div class="col-xs-4 col-md-4"> <div class=article__comments> <a href="https://kevinjalbert.com/no-excuses-verifying-rspec-test-doubles/#disqus_thread">0 Comments</a> </div> </div> </div> <div class="row article__meta-tags"> <div class="col-xs-12 col-md-12"> <div class=article__tags> <a href="/tags/rspec/">rspec</a> <a href="/tags/testing/">testing</a> </div> </div> </div> <div class=article__separator></div> <div class=article__notes> <div class="panel panel-default"> <div class=panel-heading> <h4 class="panel-title accordion-toggle collapsed" data-toggle=collapse data-parent="#accordion" href="#notesCollapse"> Notes Since Publication </h4> </div> <div id=notesCollapse class="panel-collapse collapse"> <div class=panel-body> <div class=row> <div class="article__notes-type col-xs-6 col-md-6"> ADD </div> <div class="article__notes-date col-xs-6 col-md-6"> January 23, 2016 </div> <div class="article__notes-content col-xs-12 col-md-12"> <p>Mention of RSpec 3.2&#39;s support for dynamic column methods defined by ActiveRecord in the context of <code>instance_double</code>.</p> </div> </div> </div> </div> </div> </div> <p>Tests which utilize external services or interact with the database are typically the culprits of long-running tests. We want to keep our tests quick. It is possible to mock/stub out long running database and/or external services calls. This reduces the time a test suite takes to execute.</p> <h2>Unsheathe the Double</h2> <p>In Ruby, one approach to mocking is by completely replacing the object of interest with a lightweight <a href="http://www.rubydoc.info/gems/rspec-mocks/frames#Test_Doubles">double</a> using <a href="http://rspec.info/">RSpec</a>. Proper usage of a <em>double</em> can prevent tests from interacting with external services, such as a database (i.e., <code>ActiveRecord</code>).</p> <p>With respect to RSpec, a <em>double</em> is created by providing a classname or object, along with a hash of messages and their responses. A <em>double</em> can only respond using the provided responses to their defined messages (technically there are other messages that a <em>double</em> can respond to, but for our purpose we do not have to worry about them).</p> <pre class="highlight ruby"><code><span class="n">dog</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="s1">'Dog'</span><span class="p">,</span> <span class="ss">talk: </span><span class="s1">'Woof'</span><span class="p">)</span>
<span class="n">dog</span><span class="p">.</span><span class="nf">talk</span>  <span class="c1">#=&gt; "Woof"</span>
<span class="n">dog</span><span class="p">.</span><span class="nf">walk</span>  <span class="c1">#=&gt; Double "Dog" received unexpected message :walk with (no args)</span>
</code></pre> <p>In the above example, a <code>&#39;Dog&#39;</code> <em>double</em> is created that only knows <code>#talk</code>. When it receives an unknown message like <code>#walk</code> an appropriate exception is raised.</p> <h2>Double-Edge Double</h2> <p>A <em>double</em> aims to abstract away from the concrete concepts that they are <em>standing in for</em> (i.e., defined classes/methods/attributes/associations and their implementations). This can simplify tests by only dealing with the immediate concerns in a restricted scope. Using <em>doubles</em> has its perks, but a problem can arise if changes occur to the underlying concrete concepts.</p> <p>Lets examine the following scenario:</p> <blockquote> <p>We have an existing class with multiple defined methods. This class and its methods primarily interact with external services. This class and its methods are used within our test suite, in where we have mocked it out using a <em>double</em>.</p> <p>We decided to modify a method definition on the described class. Our tests continue to pass.</p> </blockquote> <p>Given this scenario we would hope that by modifying the method definition that our existing tests which depend on said method definition to fail. Our tests are using a <em>double</em> in which the method definition it has defined is still valid, even when the actual method definition has been altered.</p> <p>The consequences of not seeing any failing tests can be serious. Even with minor cosmetic changes, that do not alter functionality, it is still a misleading test. Identifying these tests after the fact can be challenging, as they initially appear to be in fine working order.</p> <p>It is important to always remember to check the usage of <em>doubles</em> whose underlying concepts are changed. A gem called <a href="https://github.com/xaviershay/rspec-fire">rspec-fire</a> was created to alleviate this task. This gem would verify that a <em>double</em> is actually mocking an actual method defined on the concrete object. As of <a href="http://rspec.info/blog/2014/05/notable-changes-in-rspec-3">RSpec 3.0</a>, <em>rspec-fire</em> is now obsolete as RSpec has a set of new <a href="https://relishapp.com/rspec/rspec-mocks/v/3-0/docs/verifying-doubles">verifying doubles</a>. With the release of <a href="http://rspec.info/blog/2015/02/rspec-3-2-has-been-released">RSpec 3.2</a>, <code>instance_double</code> now support dynamic column methods defined by ActiveRecord.</p> <h2>Dance of the Double</h2> <p>A simple example best illustrates the downside of using the original RSpec <em>doubles</em>. In this example we also show how to replace the <em>double</em> with the new and improved verifying <em>doubles</em>, along with their benefits.</p> <p>For this example we are not dealing with a database, although the idea is easily extendable. We can imagine that our test is creating actual entries in the database, thus incurring the performance hit.</p> <hr> <p>First we define an <code>Owner</code> that has a <code>Dog</code>. The <code>Dog</code> responds to <code>#talk</code>. In addition we have a corresponding test that uses a <em>double</em> to mock out the <code>Dog</code> which responds to <code>#talk</code>.</p> <pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Owner</span>
  <span class="kp">attr_reader</span> <span class="ss">:dog</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span>
    <span class="vi">@dog</span> <span class="o">=</span> <span class="n">dog</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Dog</span>
  <span class="k">def</span> <span class="nf">talk</span>
    <span class="s1">'Woof'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Owner</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="no">Owner</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:dog</span><span class="p">)</span> <span class="p">{</span> <span class="n">double</span><span class="p">(</span><span class="s1">'Dog'</span><span class="p">,</span> <span class="ss">talk: </span><span class="s1">'Fake Woof'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="p">.</span><span class="nf">dog</span><span class="p">.</span><span class="nf">talk</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'Fake Woof'</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># 1 example, 0 failures</span>
</code></pre> <hr> <p>We decide to change <code>Dog#talk</code> to <code>Dog#bark</code>, but forget to update the test.</p> <pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Owner</span>
  <span class="kp">attr_reader</span> <span class="ss">:dog</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span>
    <span class="vi">@dog</span> <span class="o">=</span> <span class="n">dog</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Dog</span>
  <span class="k">def</span> <span class="nf">bark</span>
    <span class="s1">'Woof'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Owner</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="no">Owner</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:dog</span><span class="p">)</span> <span class="p">{</span> <span class="n">double</span><span class="p">(</span><span class="s1">'Dog'</span><span class="p">,</span> <span class="ss">talk: </span><span class="s1">'Fake Woof'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="p">.</span><span class="nf">dog</span><span class="p">.</span><span class="nf">talk</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'Fake Woof'</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># 1 example, 0 failures</span>
</code></pre> <p>From our test&rsquo;s perspective everything is still fine, since our <em>double</em> still responds to <code>#talk</code>. Ideally we would want our test here to fail since it is not accurately matching the interface defined by an actual <code>Dog</code> instance.</p> <p>This is a problem. It is possible to completely <em>forget</em> about fixing the test, since it technically passed.</p> <hr> <p>This time we use a verifying <em>double</em> that RSpec provides such as an <code>instance_double</code>. This ensures that the messages the <em>double</em> receives are verified against the interface defined by the concrete object.</p> <pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'rspec'</span>

<span class="k">class</span> <span class="nc">Owner</span>
  <span class="kp">attr_reader</span> <span class="ss">:dog</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span>
    <span class="vi">@dog</span> <span class="o">=</span> <span class="n">dog</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Dog</span>
  <span class="k">def</span> <span class="nf">bark</span>
    <span class="s1">'Woof'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Owner</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="no">Owner</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:dog</span><span class="p">)</span> <span class="p">{</span> <span class="n">instance_double</span><span class="p">(</span><span class="s1">'Dog'</span><span class="p">,</span> <span class="ss">talk: </span><span class="s1">'Fake Woof'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="p">.</span><span class="nf">dog</span><span class="p">.</span><span class="nf">talk</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'Fake Woof'</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># Failure/Error: let(:dog) { instance_double('Dog', talk: 'Fake Woof') }</span>
<span class="c1">#   Dog does not implement: talk</span>
<span class="c1"># 1 example, 1 failure</span>
</code></pre> <p>Now we have a failing test! This is what we expect to happen as our <em>double</em> is attempting to using an unimplemented method. This feedback allows us to take the corrective action on our tests to ensure that they are not forgotten and invalid.</p> <hr> <p>We now decide to change the number of arguments on <code>Dog#bark</code>. Again with the old non-verifying <em>double</em> our test would again simply pass. The verifying <em>doubles</em> also check that the number of arguments match the defined interface&rsquo;s number of arguments.</p> <pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'rspec'</span>

<span class="k">class</span> <span class="nc">Owner</span>
  <span class="kp">attr_reader</span> <span class="ss">:dog</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span>
    <span class="vi">@dog</span> <span class="o">=</span> <span class="n">dog</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Dog</span>
  <span class="k">def</span> <span class="nf">talk</span><span class="p">(</span><span class="n">loud</span><span class="p">)</span>
    <span class="n">loud</span> <span class="p">?</span> <span class="s1">'Woof'</span> <span class="p">:</span> <span class="s1">'Woof!!'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Owner</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="no">Owner</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:dog</span><span class="p">)</span> <span class="p">{</span> <span class="n">instance_double</span><span class="p">(</span><span class="s1">'Dog'</span><span class="p">,</span> <span class="ss">talk: </span><span class="s1">'Fake Woof'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="p">.</span><span class="nf">dog</span><span class="p">.</span><span class="nf">talk</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'Fake Woof'</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># Failure/Error: let(:dog) { instance_double('Dog', talk: 'Fake Woof') }</span>
<span class="c1">#   Wrong number of arguments. Expected 1, got 0.</span>
<span class="c1"># 1 example, 1 failure</span>
</code></pre> <h2>Double Development</h2> <p>If the underlying class is loaded <code>instance_double</code> will do the verifying on the class. In the situation where the class is not loaded than it acts as a normal <em>double</em>.</p> <p>During development an <code>instance_double</code> allows one to develop in isolation if the class you are mocking out does not yet exist. Eventually when the test is more-or-less complete, it is possible to simply <em>load</em> the class and the <code>instance_double</code> will start to verify on the loaded class.</p> <p>In addition, during development you can use <a href="https://github.com/nevir/rubocop-rspec/blob/master/lib/rubocop/cop/rspec/verified_doubles.rb"><code>rubocop-rspec</code></a> to ensure you always verify your <em>doubles</em>.</p> <h2>Concluding Double</h2> <p><strong>TL;DR &ndash; There are no excuses, verify your RSpec test doubles.</strong></p> <p>Verifying your RSpec test <em>doubles</em> can, and will, save you from many headaches down the road. In most cases the change required to use verifying <em>doubles</em> is relatively easy. The benefits are clear, worthwhile and your test suite will thank you.</p> <div id=disqus_thread></div> <script>
//<![CDATA[
                  var disqus_shortname = 'kevinjalbert';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <a href="http://disqus.com" class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a> <script>
//<![CDATA[
    var disqus_shortname = 'kevinjalbert';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
//]]>
</script> </div> </div> </div> </body> <div class="col-md-12 footer__copywrite"> &copy; 2015 Kevin Jalbert </div> </html> <script src="/javascripts/app.js"></script> <script>!function(e,a,n,t,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(n),s=a.getElementsByTagName(n)[0],o.async=1,o.src=t,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-16620161-5","kevinjalbert.com"),ga("send","pageview");</script>