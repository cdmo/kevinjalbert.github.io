<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <title>Sidekiq: Contained Callbacks — Kevin Jalbert</title> <link href="/stylesheets/app.css" rel=stylesheet /> <link rel=alternate type="application/atom+xml" title="Posts — Kevin Jalbert" href="/feed.xml"/> </head> <div class=container> <div class=header> <div class="col-xs-4 col-md-4 banner"> <a href="/">Kevin Jalbert</a> </div> <div class="col-xs-8 col-md-8 navigation"> <ul> <li><input placeholder=Search class="search ui-autocomplete-input ui-corner-all" autocomplete=on></li> <li><a href="/about/">About</a></li> <li><a href="/now/">Now</a></li> </ul> </div> </div> </div> <body> <div class="container content article"> <div class=row> <div class=col-md-12> <h1 class=article__title><p>Sidekiq: Contained Callbacks</p> </h1> <div class="row article__meta-info"> <div class="col-xs-4 col-md-4"> <div class=article__date>October 31, 2016 </div> </div> <div class="col-xs-4 col-md-4"> <div class=article__read-time>3 min read</div> </div> <div class="col-xs-4 col-md-4"> <div class=article__comments> <a href="https://kevinjalbert.com/sidekiq-contained-callbacks/#disqus_thread">0 Comments</a> </div> </div> </div> <div class="row article__meta-tags"> <div class="col-xs-12 col-md-12"> <div class=article__tags> <a href="/tags/ruby/">ruby</a> <a href="/tags/rails/">rails</a> <a href="/tags/sidekiq/">sidekiq</a> </div> </div> </div> <div class=article__separator></div> <div class=newsletter__form> <div class="panel panel-default"> <div class=panel-heading> <h4 class="panel-title accordion-toggle collapsed" data-toggle=collapse data-parent="#accordion" href="#newsletterFormCollapse"> Signup for my Newsletter </h4> </div> <div id=newsletterFormCollapse class="panel-collapse collapse"> <div class=panel-body> <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel=stylesheet> <style>
              #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
              /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
                 We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
        </style> <div id=mc_embed_signup> <form action="//kevinjalbert.us14.list-manage.com/subscribe/post?u=fe02783eec556cfc2893fe174&amp;id=aecd14f8e6" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate> <div id=mc_embed_signup_scroll> <input type=email value="" name=EMAIL class=email id=mce-EMAIL placeholder="email address" required> <div style="position: absolute; left: -5000px;" aria-hidden=true><input name=b_fe02783eec556cfc2893fe174_aecd14f8e6 tabindex=-1 value=""></div> <div class=clear><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class=button></div> </div> </form> </div> </div> </div> </div> </div> <h2>ActiveSupport Callbacks</h2> <p>In my <a href="/lets-pry-into-ruby-objects/">last post</a> I touched on <code>pry</code> and how it helped me verify that my class had <code>around_perform</code> ActiveSupport Callbacks attached to it. In this post I will delve further into <em>what</em> I was trying to accomplish.</p> <h2>[ActiveJob, Sidekiq] - [ActiveJob]</h2> <p>I was working on a Rails 4.2.x project that had background job processing. We used <a href="https://github.com/rails/rails/tree/4-2-stable/activejob">ActiveJob</a> as our adapter to our background jobs. Behind the scenes, we were using the <a href="http://sidekiq.org/">Sidekiq</a> gem.</p> <p>We eventually needed specifics that only native Sidekiq can provide through its <code>sidekiq_options</code>. These options that Sidekiq provides were something that we didn&rsquo;t need initially. As mentioned in the <a href="https://github.com/mperham/sidekiq/wiki/Active-Job#active-job-introductio://github.com/mperham/sidekiq/wiki/Active-Job#active-job-introduction">Sidekiq Wiki</a>:</p> <blockquote> <p>Note that more advanced Sidekiq features (<code>sidekiq_options</code>) cannot be controlled or configured via ActiveJob, e.g. saving backtraces.</p> </blockquote> <p>The time has come to take advantage of powerful sidekiq gems and options, thus we have to switch from ActiveJob to native Sidekiq.</p> <h1>ActiveJob&rsquo;s Free Perks</h1> <p>ActiveJob provided certain features automatically such as using <a href="http://guides.rubyonrails.org/active_job_basics.html#globalid">GlobalID</a> and setting up <a href="http://guides.rubyonrails.org/active_job_basics.html#callbacks">Callbacks</a>, amongst others. With a native Sidekiq approach we lose those <em>free</em> perks.</p> <p>The biggest thing we missed was the callbacks, specifically <code>around_perform</code>. We had several modules that were mixed in to our job classes, with the single responsibility of augmenting the class with callbacks.</p> <p>For example:</p> <pre class="highlight ruby"><code><span class="k">module</span> <span class="nn">JobMetrics</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="n">around_perform</span> <span class="k">do</span> <span class="o">|</span><span class="n">_job</span><span class="p">,</span> <span class="n">block</span><span class="o">|</span>
      <span class="no">MetricsLogger</span><span class="p">.</span><span class="nf">timing</span><span class="p">(</span><span class="n">metrics_logger_key</span><span class="p">)</span> <span class="p">{</span> <span class="n">block</span><span class="p">.</span><span class="nf">call</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">metrics_logger_key</span>
      <span class="vi">@metrics_logger_key</span> <span class="o">||=</span> <span class="n">signature</span><span class="p">.</span><span class="nf">underscore</span><span class="p">.</span><span class="nf">tr</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre> <p>This module is wrapping the actual job&rsquo;s <code>#perform</code> in a <code>MetricsLogger.timing</code>. In a future post, I might go into further details about <code>MetricsLogger</code>, but at its core it records a key/value and sends it off to a log aggregator. The benifit we get from this module is the ability to know timing metrics for jobs based on an identifying signature.</p> <p>Moving away from ActiveJob, we need another way to accomplish the same thing (<em>contained callbacks</em>) with just Sidekiq.</p> <h2>Contained Callbacks</h2> <p>The goal is to have contained callbacks, which is just a seperate module that can be included on jobs that deifne the required callback. This approach means that little has to change while removing ActiveJob, and we can reuse all our existing contained callbacks.</p> <h3>Prepend a Proxy</h3> <p>I found out that to make use of <code>ActiveSupport::Callbacks</code> you have to modify the executed method, which in our case would be the job&rsquo;s <code>#perform</code>.</p> <pre class="highlight ruby"><code><span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">def</span> <span class="n">perform</span>
    <span class="n">run_callbacks</span> <span class="ss">:perform</span> <span class="k">do</span>
      <span class="c1"># Actual perform's content here</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span>

</code></pre> <p>I didn&rsquo;t want to modify the <code>#perform</code> method definitions for all the jobs. So I came up with the solution of using <code>prepend</code> to slot a proxy in front of the jobs&rsquo; <code>#perform</code>.</p> <pre class="highlight ruby"><code><span class="k">module</span> <span class="nn">SidekiqCallbacks</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">run_callbacks</span> <span class="ss">:perform</span> <span class="k">do</span>
      <span class="k">super</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre> <p>This module then can be prepended into the Sidekiq job classes and the callbacks will be executed &ndash; if they are present. The next task is to support the <code>around_perform</code> callback.</p> <h3>Support Setting and Running Callbacks</h3> <pre class="highlight ruby"><code><span class="nb">require</span> <span class="s2">"active_support/callbacks"</span>

<span class="c1"># Following approach used by ActiveJob</span>
<span class="c1"># https://github.com/rails/rails/blob/93c9534c9871d4adad4bc33b5edc355672b59c61/activejob/lib/active_job/callbacks.rb</span>
<span class="k">module</span> <span class="nn">SidekiqCallbacks</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">respond_to?</span><span class="p">(</span><span class="ss">:run_callbacks</span><span class="p">)</span>
      <span class="n">run_callbacks</span> <span class="ss">:perform</span> <span class="k">do</span>
        <span class="k">super</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="k">super</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">ClassMethods</span>
    <span class="k">def</span> <span class="nf">around_perform</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span>
      <span class="n">set_callback</span><span class="p">(</span><span class="ss">:perform</span><span class="p">,</span> <span class="ss">:around</span><span class="p">,</span> <span class="o">*</span><span class="n">filters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre> <p>Now <code>SidekiqCallbacks</code> defines the ability to add callbacks, and they will be executed before <code>#perform</code> if defined.</p> <h3>Wrapping it up</h3> <p>The last thing I want to do is to encapsulate this Sidekiq callback logic in its own module that defines the actual callback (i.e., <code>JobMetrics</code>). To do this, we need to further modify <code>SidekiqCallbacks</code>.</p> <pre class="highlight ruby"><code><span class="nb">require</span> <span class="s2">"active_support/callbacks"</span>

<span class="c1"># Following approach used by ActiveJob</span>
<span class="c1"># https://github.com/rails/rails/blob/93c9534c9871d4adad4bc33b5edc355672b59c61/activejob/lib/active_job/callbacks.rb</span>
<span class="k">module</span> <span class="nn">SidekiqCallbacks</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">prepended</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="n">base</span><span class="p">.</span><span class="nf">include</span><span class="p">(</span><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Callbacks</span><span class="p">)</span>

    <span class="c1"># Check to see if we already have any callbacks for :perform</span>
    <span class="c1"># Prevents overwritting callbacks if we already included this module (and defined callbacks)</span>
    <span class="n">base</span><span class="p">.</span><span class="nf">define_callbacks</span> <span class="ss">:perform</span> <span class="k">unless</span> <span class="n">base</span><span class="p">.</span><span class="nf">respond_to?</span><span class="p">(</span><span class="ss">:_perform_callbacks</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">base</span><span class="p">.</span><span class="nf">_perform_callbacks</span><span class="p">.</span><span class="nf">present?</span>

    <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="n">base</span>
      <span class="n">prepend</span> <span class="no">ClassMethods</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">respond_to?</span><span class="p">(</span><span class="ss">:run_callbacks</span><span class="p">)</span>
      <span class="n">run_callbacks</span> <span class="ss">:perform</span> <span class="k">do</span>
        <span class="k">super</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="k">super</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">ClassMethods</span>
    <span class="k">def</span> <span class="nf">after_perform</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span>
      <span class="n">set_callback</span><span class="p">(</span><span class="ss">:perform</span><span class="p">,</span> <span class="ss">:after</span><span class="p">,</span> <span class="o">*</span><span class="n">filters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre> <p>We had to include the <code>self.prepended</code> so that the job class will have access to the defined methods through the contained callback module. The main thing to note here is that we are including <code>ActiveSupport::Callbacks</code> on the base object that is prepending this module. We also have to ensure that the callbacks are only defined once (this is where in my <a href="/lets-pry-into-ruby-objects/">last post</a> I was using <code>pry</code> figure why not all my callbacks were defined).</p> <pre class="highlight ruby"><code><span class="k">module</span> <span class="nn">JobMetrics</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="n">prepend</span> <span class="no">SidekiqCallbacks</span>

    <span class="n">around_perform</span> <span class="k">do</span> <span class="o">|</span><span class="n">_job</span><span class="p">,</span> <span class="n">block</span><span class="o">|</span>
      <span class="no">MetricsLogger</span><span class="p">.</span><span class="nf">timing</span><span class="p">(</span><span class="n">metrics_logger_key</span><span class="p">)</span> <span class="p">{</span> <span class="n">block</span><span class="p">.</span><span class="nf">call</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">metrics_logger_key</span>
      <span class="vi">@metrics_logger_key</span> <span class="o">||=</span> <span class="n">signature</span><span class="p">.</span><span class="nf">underscore</span><span class="p">.</span><span class="nf">tr</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre> <p>Finally, we can see how <code>JobMetrics</code> has a new <code>prepend SidekiqCallbacks</code> and that pulls in all the required <code>ActiveSupport::Callback</code> logic that allows for callbacks to be defined and executed.</p> <h3>The Win</h3> <p>With this approach, the benifit is that the callback implementation is completely contained within the <code>JobMetrics</code> module. The <code>SidekiqCallbacks</code> module provides the missing ActiveJob callback support for <code>around_perform</code>. It is also possible to add the missing ActiveJob callbacks using this approach.</p> <p>In the ending, the concrete job classes just <code>include</code> the contained callback module (i.e., <code>JobMetrics</code>). <code>SidekiqCallbacks</code> is designed to accomodate multiple contained callback modules being included on a single concrete job class.</p> <div id=disqus_thread></div> <script>
//<![CDATA[
                  var disqus_shortname = 'kevinjalbert';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <a href="http://disqus.com" class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a> <script>
//<![CDATA[
    var disqus_shortname = 'kevinjalbert';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
//]]>
</script> </div> </div> </div> </body> <div class="col-md-12 footer__copywrite"> &copy; 2017 Kevin Jalbert </div> </html> <script src="/javascripts/app.js"></script> <script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-16620161-5']);
    _gaq.push(['_trackPageview']);

    setTimeout(function() {
      window.onscroll = function() {
        window.onscroll = null; // Only track the event once
        _gaq.push(['_trackEvent', 'scroll', 'read']);
      }
    }, 5000);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>